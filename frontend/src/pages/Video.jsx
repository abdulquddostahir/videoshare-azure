import React from 'react'
import { useParams } from 'react-router-dom'
import { apiBase } from '../config'
export default function Video(){const {id}=useParams();const [data,setData]=React.useState(null);const [comment,setComment]=React.useState('');const [rating,setRating]=React.useState(5);const token=localStorage.getItem('token')||'';React.useEffect(()=>{fetch(apiBase()+'/videos/'+id).then(r=>r.json()).then(setData)},[id]);const submitComment=async()=>{if(!comment.trim())return;const res=await fetch(apiBase()+'/comments',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},body:JSON.stringify({videoId:id,text:comment})});const saved=await res.json();setData(d=>({...d,comments:[saved,...(d.comments||[])]}));setComment('')};const submitRating=async()=>{await fetch(apiBase()+'/ratings',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},body:JSON.stringify({videoId:id,rating:Number(rating)})});const refreshed=await(await fetch(apiBase()+'/videos/'+id)).json();setData(refreshed)};if(!data) return <div className='container'>Loading…</div>;return(<div className='container'><h2>{data.title} <span className='badge'>{data.genre}</span> <span className='badge'>Age: {data.ageRating}</span></h2><div className='small'>Publisher: {data.publisher} · Producer: {data.producer}</div><div className='card'><video src={data.streamUrl} controls preload='metadata'/></div><div className='card'><h3>Rate</h3><div style={{display:'flex',gap:'1rem',alignItems:'center'}}><select value={rating} onChange={e=>setRating(e.target.value)}>{[1,2,3,4,5].map(n=><option key={n} value={n}>{n}</option>)}</select><button className='btn' onClick={submitRating}>Submit rating</button><span className='small'>Average: {data.avgRating?.toFixed?.(1) ?? 'N/A'} ({data.ratingCount||0} ratings)</span></div></div><div className='card'><h3>Comments</h3><div style={{display:'flex',gap:'.5rem'}}><input placeholder='Write a comment' value={comment} onChange={e=>setComment(e.target.value)}/><button className='btn' onClick={submitComment}>Post</button></div><ul>{(data.comments||[]).map(c=>(<li key={c.id} style={{marginTop:'.5rem'}}><b>{c.userEmail}</b> — <span className='small'>{new Date(c.createdAt).toLocaleString()}</span><br/>{c.text}{c.sentiment&&<span className='badge'>Sentiment: {c.sentiment.label} ({c.sentiment.score.toFixed(2)})</span>}</li>))}</ul></div></div>)}
