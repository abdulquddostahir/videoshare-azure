const { containers, bcrypt, sign }=require('../utils.js');module.exports=async function(context,req){const {email,password}=req.body||{};if(!email||!password){context.res={status:400,body:{error:'Email and password required'}};return}const {users}=await containers();const q=await users.items.query({query:'SELECT * FROM c WHERE c.email=@e',parameters:[{name:'@e',value:email.toLowerCase()}]}).fetchAll();const u=q.resources[0];if(!u){context.res={status:401,body:{error:'Invalid credentials'}};return}const ok=await bcrypt.compare(password,u.passHash);if(!ok){context.res={status:401,body:{error:'Invalid credentials'}};return}const token=sign(u);context.res={body:{token,user:{id:u.id,email:u.email,role:u.role}}}}