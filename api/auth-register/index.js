const { containers, bcrypt, sign, uuidv4 }=require('../utils.js');module.exports=async function(context,req){const {email,password}=req.body||{};if(!email||!password){context.res={status:400,body:{error:'Email and password required'}};return}const {users}=await containers();const q=await users.items.query({query:'SELECT * FROM c WHERE c.email=@e',parameters:[{name:'@e',value:email.toLowerCase()}]}).fetchAll();if(q.resources.length){context.res={status:409,body:{error:'Email already registered'}};return}const id=uuidv4();const passHash=await bcrypt.hash(password,10);const user={id,email:email.toLowerCase(),passHash,role:'consumer',createdAt:new Date().toISOString()};await users.items.create(user);const token=sign(user);context.res={status:201,body:{token,user:{id:user.id,email:user.email,role:user.role}}}}